# Agent Instructions for Google Sheets Q&A Project

This document provides instructions for AI agents working on this codebase.

## 1. Project Overview

This project is a web application that allows users to ask natural language questions about data in a spreadsheet. It uses a Large Language Model (LLM) via the OpenRouter API to convert the user's question into a Python Pandas script, which is then executed to produce an answer.

The application has two main interfaces:
1.  A web interface built with Streamlit (`main.py`).
2.  A headless test harness (`test_harness.py`) for automated testing.

A key security feature of this project is the sandboxing mechanism (`child_runner.py` and `sandbox.py`), which is designed to safely execute the code generated by the LLM.

## 2. File Structure

-   `main.py`: The main entry point for the Streamlit web application. This file handles the UI and orchestrates the call to the Q&A logic.
-   `prepare_injection.py`: A utility script to pre-process an Excel file (`.xlsx`) into a Python pickle file (`.pkl`). This is a required setup step.
-   `test_harness.py`: A script for running automated, headless tests of the core `run_query` logic.
-   `child_runner.py`: A script that creates a highly restricted, sandboxed environment to run untrusted Python code. It blocks modules like `os` and file system access. **This is not meant for running utility scripts.**
-   `sandbox.py`: A wrapper script that likely uses `child_runner.py` to execute a target script in the sandbox.
-   `OMR.xlsx`: The source Excel data file provided by the user.
-   `requirements.txt`: A list of Python dependencies required for the project.
-   `.gitignore`: Specifies files and directories that should be ignored by Git (e.g., `.env`, `__pycache__`, `*.pkl`).
-   `injected_dfs.pkl`: **Generated file.** This is the output of `prepare_injection.py`. It should not be committed to version control.

## 3. Development Workflow

Follow these steps carefully to set up and run the project.

### Step 1: Environment Setup

1.  **Install Dependencies:** Make sure you have Python 3 installed. Then, install all required packages using pip:
    ```bash
    pip install -r requirements.txt
    ```

2.  **Set Up API Key:** The application requires an API key for the OpenRouter service. This key must be provided as an environment variable named `OPENROUTER_API_KEY`.
    -   **For local development:** Create a file named `.env` in the root of the project directory. This file is listed in `.gitignore` and will not be committed. Add the following line to it, replacing `<your_key_here>` with the actual key:
        ```
        OPENROUTER_API_KEY=<your_key_here>
        ```
    -   **For hosted platforms (like Replit):** Use the platform's built-in secrets management tool to set the `OPENROUTER_API_KEY` environment variable.

### Step 2: Prepare Data

Before running the main application or tests, you must convert the Excel data into a pickle file.

-   Run the following command in your terminal:
    ```bash
    python3 prepare_injection.py --excel OMR.xlsx
    ```
-   This will create the `injected_dfs.pkl` file, which the application and test harness will use.
-   **IMPORTANT:** Do **NOT** run this script inside the sandbox (e.g., `python3 sandbox.py prepare_injection.py`). The script needs access to the file system, which the sandbox blocks.

### Step 3: Run the Web Application

To use the interactive web UI, run the following command:
```bash
streamlit run main.py
This will start a local web server and provide a URL to access the application in your browser.

Step 4: Run Tests
To verify the core logic of the application, use the test harness.

Make sure your OPENROUTER_API_KEY is set as an environment variable (see Step 1).
Make sure you have run the data preparation script (Step 2).
Execute the test harness:
python3 test_harness.py
A helper script, run_checks.sh, is also provided to automate this.
4. Architectural Notes
Separation of Concerns: The main.py script has been refactored to separate the Streamlit UI code (in the main() function) from the core business logic (like run_query, ask_llm_for_code, etc.). This makes the logic reusable and easier to test.
Explicit Dependency Injection: The run_query function and its helpers now require the api_key to be passed as an explicit argument. This avoids reliance on fragile global variables and makes the functions' dependencies clear, which was crucial for fixing authentication bugs.
LLM Output Parsing: The run_query function includes logic to parse Python code from within a markdown block (e.g., python...). This makes the system more robust to variations in LLM output.
5. Programmatic Checks
A helper script run_checks.sh is included to automate verification. It currently runs the main test harness. To use it, first make it executable:

chmod +x run_checks.sh
Then run it:

./run_checks.sh
Make sure your OPENROUTER_API_KEY is available in your environment before running the script.
